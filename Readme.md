# Bookstore文档

### 目的简述

这个项目的设计初衷是使用DDD的思想，去构建一个业务上简单易扩展和易拆分的单体服务的实现。  
没有直接拆成微服务的原因是，牵涉到服务发现，服务治理，可观测，RPC等一系列技术选型和实现，工作量实在有点大。  
这个单体服务的技术选型上，为了能过跑起来方便，不会引入常用的缓存，数据库的中间件。选用Sqlite，Caffine替代直接运行在单体服务进程内。

### 依赖环境和框架
* open JDK 21
* SpringBoot 3.3.4
* gradel 8.10.1

### 运行方法

* 运行测试用例  
./gradlew test  


* 运行服务  
./gradlew bootRun


* 打包docker镜像  
./docker build -t linghuyong/bookstore:1.0 .


### 项目结构
./sql 存放db schema  
./sqlite_db 存放sqlite数据库文件

源代码.src/.../bookstore 目录下参考了DDD的四层架构  
./application DDD的应用层  
./domain    业务领域层  
./infrastructure 基础设施层  
./interfaces    用户接口层  

测试用例都在./test下

### 实现内容

* 用户领域
  * 实现注册，登录，获取用户信息的基本功能
* security领域
  * 集成了Spring security的能力，将B端的admin接口和C端的api接口，分别授权管理。
  * admin接口可以使用简单的basic登录方式
  * c端的接口可以通过login换取JWTToken来实现鉴权
* 图书领域
  * 实现了图书信息的新增和修改的功能
  * 实现了图书的库存管理功能
  * 实现了图书作者子领域的创建功能
  * 图书分类目前是接口参数指定，如有分类模型，可以在图书创建流程中使用领域事件扩展接入。
* 订单领域
  * 实现了用户针对某本书下单的流程。
  * 订单状态流转
    * 用户: 已创建  ---> 用户/系统：已取消
    * 用户: 已创建  ---> 后台：已接受  设计接受阶段是为了给系统接入风控系统的空间，由风控算法来决定是否接受这个订单
    * 后台：已接受  ---> 后台: 已完成  被接受的订单，可以由后台操作完成。（这里简化了业务流程，没有设计支付，履约环节）
* 商城页面领域
  * 搭建了一个在商城页面上可能会进行的ABTest实验的场景
  * 具体的实验场景描述，见PageDomainService.java内的注释

### 技术细节说明
* 使用了Spring Cache组件来实现缓存功能，数据一致性采用领域内事件通知缓存对象变更，删除缓存的方式实现。
* 并发优化，原本设计是图书库存使用行锁，订单状态修改使用乐观锁的机制来实现。跑测试用例发现Sqlite不支持行锁，只能用它提供的事务的文件锁，性能是蛮差的。
* 使用Junit5做单元测试，时间紧张很多用例来不及补全了。
* ABTest框架，我的设计思想是使用实验后台配管和管理实验参数和生命周期。接入的客户端有很多特性点需要实现，比如服务器配置连接，分流缓存策略，实验推全逻辑选择等，实在没有时间实现，所以就搭了个架子。